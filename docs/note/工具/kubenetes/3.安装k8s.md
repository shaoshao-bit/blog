
> ğŸ“Œå†…å®¹æ¥è‡ª[https://www.jianshu.com/p/dea93dea5a4e](https://www.jianshu.com/p/dea93dea5a4e "https://www.jianshu.com/p/dea93dea5a4e")

## å®‰è£…æ–¹å¼

è¿™é‡Œä½¿ç”¨kubeadmè¿›è¡Œå®‰è£…ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨äºŒè¿›åˆ¶å®‰è£…ã€‚

[kubeadm](https://links.jianshu.com/go?to=https://kubernetes.io/zh/docs/reference/setup-tools/kubeadm/kubeadm/ "kubeadm")æ˜¯Kuberneteså®˜æ–¹æä¾›çš„ç”¨äºå¿«é€Ÿå®‰è£… Kubernetes é›†ç¾¤çš„å·¥å…·ï¼Œå®ƒæä¾›äº† `kubeadm init`ä»¥åŠ `kubeadm join` è¿™ä¸¤ä¸ªå‘½ä»¤ä½œä¸ºå¿«é€Ÿåˆ›å»º kubernetes é›†ç¾¤çš„æœ€ä½³å®è·µï¼Œåªéœ€å°†`kubeadm`,`kubelet`ï¼Œ`kubectl`å®‰è£…åˆ°æœåŠ¡å™¨ï¼Œå…¶ä»–æ ¸å¿ƒç»„ä»¶ä»¥å®¹å™¨åŒ–æ–¹å¼å¿«é€Ÿéƒ¨ç½²ã€‚

## ç³»ç»Ÿç¯å¢ƒ

> ç³»ç»Ÿç‰ˆæœ¬ï¼š
> å†…æ ¸ç‰ˆæœ¬ï¼š
> Dockerç‰ˆæœ¬ï¼š
> k8sç‰ˆæœ¬ï¼š

ä¸»æœºä¿¡æ¯ï¼š

*   192.168.122.110 k8s-master

*   192.168.122.2 k8s-node01

*   192.168.122.105 k8s-node02

å‘æ¯ä¸ªèŠ‚ç‚¹æ·»åŠ hostsä¿¡æ¯

```bash
$ cat <<EOF >> /etc/hosts
192.168.122.110 k8s-master
192.168.122.2 k8s-node01
192.168.122.105 k8s-node02
EOF
```

ç¦ç”¨æ¯å°æœºå™¨çš„Firewalldï¼ŒSelinuxï¼ŒSwap

&#x20;systemctl stop firewalld&#x20;
\$ systemctl disable firewalld&#x20;
\$ setenforce 0
\$ sed -i "s/enforcing/disabled/g"  /etc/selinux/config
\$ swapoff -a&#x20;

```bash
$ systemctl stop firewalld 
$ systemctl disable firewalld 
$ setenforce 0
$ sed -i "s/enforcing/disabled/g" /etc/selinux/config
$ swapoff -a 
```

ä¿®æ”¹å†…æ ¸å‚æ•°

```bash
$ cat << EOF > /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_forward = 1
vm.swappiness=0
EOF
$ modprobe br_netfilter #æŠ¥é”™ä½¿ç”¨yum -y update æ›´æ–°å†…æ ¸æ¨¡å—
$ sysctl -p /etc/sysctl.d/k8s.conf
```

å®‰è£…ipvsï¼ˆè´Ÿè½½å‡è¡¡å™¨ï¼Œkube-proxyä½¿ç”¨ipvsæ¨¡å¼ï¼‰

```bash
$ cat > /etc/sysconfig/modules/ipvs.modules <<EOF
#!/bin/bash
modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- nf_conntrack_ipv4
EOF
$ chmod 755 /etc/sysconfig/modules/ipvs.modules && bash /etc/sysconfig/modules/ipvs.modules && lsmod | grep -e ip_vs -e nf_conntrack_ipv4
#ç”±äºç‰ˆæœ¬æ›´æ–°ï¼Œæ–°çš„å†…æ ¸ä¸­æ²¡æœ‰nf_conntrack_ipv4ï¼Œè¿è¡Œä¼šæŠ¥é”™
#å¯å°†ä¸Šé¢ç›¸å…³å†…å®¹æ”¹ä¸ºnf_conntrack
```

å®‰è£…[ipset](https://links.jianshu.com/go?to=https://wiki.archlinux.org/index.php/Ipset "ipset") (iptablesçš„æ‰©å±•)

```bash
$ yum install -y ipvsadm ipset
```

åŒæ­¥æœåŠ¡å™¨æ—¶é—´

```bash
#è¿™é‡Œæ‰§è¡Œå¤±è´¥ï¼Œyumæºæ‰¾ä¸åˆ°ntpè¿™ä¸ªåŒ…ï¼Œæš‚æ—¶æ²¡é…
$ yum -y install  ntp
$ ntpdate  ntp1.aliyun.com
```

## å®‰è£…docker

è¿™é‡ŒæŒ‰ç…§dockerå®˜æ–¹æ–‡æ¡£å®‰è£…æœ€æ–°ç‰ˆæœ¬docker

```bash
 $ sudo yum remove docker \
                  docker-client \
                  docker-client-latest \
                  docker-common \
                  docker-latest \
                  docker-latest-logrotate \
                  docker-logrotate \
                  docker-engine
$ sudo yum install -y yum-utils
$ sudo yum-config-manager \
    --add-repo \
    https://download.docker.com/linux/centos/docker-ce.repo
#æ›´æ¢æ¸…åæºdocker
#sed -i 's+download.docker.com+mirrors.tuna.tsinghua.edu.cn/docker-ce+' /etc/yum.repos.d/docker-ce.repo
$ #sudo yum-config-manager --enable docker-ce-nightly
$ sudo yum install -y docker-ce docker-ce-cli containerd.io
```

å¯åŠ¨docker

```powershell
$ sudo systemctl start docker
```

è¿è¡Œä¸€ä¸ª`hello-world`è¯dockeræ˜¯å¦å®‰è£…æˆåŠŸ

```bash
$ sudo docker run hello-world
```

é…ç½®dockeré•œåƒåŠ é€Ÿ

```bash
$ mkdir /etc/docker
$ cat  << EOF  > /etc/docker/daemon.json

EOF
#token åœ¨é˜¿é‡Œäº‘ç”³è¯·å¹¶ç”Ÿæˆ
#url:https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors
or
$ cat  << EOF  > /etc/docker/daemon.json
{
"registry-mirrors": [
"https://mirror.ccs.tencentyun.com"
]
}
EOF

```

é‡æ–°å¯åŠ¨dockerå¹¶è®¾ç½®å¼€æœºè‡ªå¯

```bash
$ systemctl restart docker
$ systemctl enable docker
```

## å®‰è£…kubeadm

æ·»åŠ é•œåƒæº

```bash
$ cat <<EOF > /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
        http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF
```

å®‰è£…kubeadm,kubelet,kubectl

```bash
$ yum install -y kubectl kubeadm kubelet
#æŸ¥çœ‹ç‰ˆæœ¬
$ kubeadm version
&version.Info{
      Major:"1", Minor:"15", GitVersion:"v1.15.3", 
      GitCommit:"2d3c76f9091b6bec110a5e63777c332469e0cba2", 
      GitTreeState:"clean", BuildDate:"2019-08-19T11:11:18Z", 
      GoVersion:"go1.12.9", Compiler:"gc", Platform:"linux/amd64"}
systemctl start  kubelet.service
#è®¾ç½®å¼€æœºè‡ªå¯
$ systemctl enable kubelet.service
```

## åˆå§‹åŒ–é›†ç¾¤

é¦–å…ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`kubeadm init`å‘½ä»¤æ¥è¿›è¡Œåˆå§‹åŒ–å·¥ä½œï¼Œå…¶ä¸­kubeadm é¦–å…ˆè¦åšçš„ï¼Œæ˜¯ä¸€ç³»åˆ—çš„æ£€æŸ¥å·¥ä½œï¼Œä»¥ç¡®å®šè¿™å°æœºå™¨å¯ä»¥ç”¨æ¥éƒ¨ç½² Kubernetesï¼Œæ¯”å¦‚æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬æ˜¯å¦æ˜¯3.10ä»¥ä¸Šï¼ŒCgroups æ¨¡å—æ˜¯å¦å¯ç”¨ï¼ŒDockeræ˜¯å¦æ­£ç¡®å®‰è£…ç­‰ï¼Œç„¶åä»¥Podçš„å½¢å¼æ¥éƒ¨ç½²`kube-apiserverã€kube-controller-managerã€kube-scheduler`è¿™äº›ç»„ä»¶ï¼Œæœ€ååˆ™æ˜¯éƒ¨ç½²`kube-proxy`å’Œ`DNS`è¿™äº›æ’ä»¶ã€‚

æˆ‘ä»¬éœ€è¦ä½¿ç”¨ä¸€äº›è‡ªå®šä¹‰çš„é…ç½®ï¼Œåœ¨MasterèŠ‚ç‚¹å¯ä»¥å¯¼å‡ºé»˜è®¤çš„åˆå§‹åŒ–æ–‡ä»¶è¿›è¡Œä¿®æ”¹ã€‚

```bash
$ kubeadm config print init-defaults > kubeadm.yaml
```

ç¼–è¾‘è¿™ä¸ªæ–‡ä»¶

```vim&#x20;script
Â·Â·Â·
localAPIEndpoint:
#ä¿®æ”¹apiserverIP
  advertiseAddress: 192.168.122.110   
  bindPort: 6443

Â·Â·Â·
#ä¿®æ”¹é•œåƒä»“åº“åœ°å€
#è¿™é‡Œgcr.azk8s.cn/google_containerså·²æ— æ³•è®¿é—®
#å¯ä»¥ä½¿ç”¨é˜¿é‡Œäº‘çš„æºï¼ˆæœ‰ç©ºå†æ”¹ï¼‰
imageRepository: gcr.azk8s.cn/google_containers 
imageRepositoryï¼š registry.aliyuncs.com/google_containers

```

åˆå§‹åŒ–é›†ç¾¤

```bash
$ kubeadm init --config kubeadm.yaml
------
[addons] Applied essential addon: CoreDNS
[addons] Applied essential addon: kube-proxy

Your Kubernetes control-plane has initialized successfully!

To start using your cluster, you need to run the following as a regular user:

  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config

You should now deploy a pod network to the cluster.
Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

Then you can join any number of worker nodes by running the following on each as root:
kubeadm join 192.168.122.110:6443 --token szu5t8.z6m03rxaamo8jzy1     --discovery-token-ca-cert-hash sha256:0455a39d0ff4cca1a9c947fa902ac635c09da5b4d7a30363e9376a9a2eb97a24

```

å¤åˆ¶kubeconfigæ–‡ä»¶

```bash
$ mkdir -p $HOME/.kube
$ sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
$ sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

## èŠ‚ç‚¹åŠ å…¥é›†ç¾¤

åœ¨MasterèŠ‚ç‚¹ç”Ÿæˆtokenåï¼Œåœ¨å…¶ä»–å®‰è£…äº†kubeletå’Œkubeadmçš„æœºå™¨ä¸Šä½¿ç”¨`join` å‘½ä»¤åŠ å…¥åˆ°kubernetesé›†ç¾¤ä¸­

```bash
$ kubeadm join 172.16.1.100:6443 --token szu5t8.z6m03rxaamo8jzy1     --discovery-token-ca-cert-hash sha256:0455a39d0ff4cca1a9c947fa902ac635c09da5b4d7a30363e9376a9a2eb97a24
#å¯ä»¥åœ¨masterä¸­ä½¿ç”¨kubeadm token create --print-join-commandé‡æ–°è·å–ã€‚
```

## å®‰è£…é›†ç¾¤æ’ä»¶

å®‰è£…calicoç½‘ç»œæ’ä»¶

```bash
#åœ¨https://docs.projectcalico.org/about/about-calicoå³ä¸Šè§’æŸ¥çœ‹æœ€æ–°ç‰ˆæœ¬
$ wget https://docs.projectcalico.org/v3.21/manifests/calico.yaml
$ kubectl apply -f calico.yaml

```

æŸ¥çœ‹Podè¿è¡ŒçŠ¶æ€

```bash
$ kubectl get pods -n kube-system

```

æŸ¥çœ‹èŠ‚ç‚¹è¿è¡ŒçŠ¶æ€

```bash
$ kubectl get nodes

```

å®‰è£…Dashboardå¯è§†åŒ–æ’ä»¶

> ğŸ“Œè¿™é‡Œç‰ˆæœ¬æœ‰é—®é¢˜ï¼Œæœ‰ç©ºå†è¡¥

```bash
$ wget https://raw.githubusercontent.com/kubernetes/dashboard/v1.10.1/src/deploy/recommended/kubernetes-dashboard.yaml
$ vim  kubernetes-dashboard.yaml #ä¿®æ”¹é•œåƒåç§°
......
containers:
- args:
  - --auto-generate-certificates
  image: gcr.azk8s.cn/google_containers/kubernetes-dashboard-amd64:v1.10.1 # ä¿®æ”¹é•œåƒåç§°
  imagePullPolicy: IfNotPresent
......
selector:
  k8s-app: kubernetes-dashboard
type: NodePort  # ä¿®æ”¹Serviceä¸ºNodePortç±»å‹
......

```

åˆ›å»ºæœåŠ¡

```bash
$ kubectl apply -f kubernetes-dashboard.yaml
```

......
